name: Feature Development

on:
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
  pull_request:
    types: [opened, synchronize, reopened]

env:
  DOTNET_VERSION: '6.0.x'

jobs:
  # Quick validation for feature branches
  quick-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore & Build
      run: |
        dotnet restore
        dotnet build --configuration Debug --no-restore
    
    - name: Fast tests
      run: dotnet test --configuration Debug --no-build --verbosity minimal

  # Component-specific testing
  component-validation:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [TaskGrid, TimelineView, GanttComposer]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Validate ${{ matrix.component }} component
      run: |
        echo "ğŸ§ª Testing ${{ matrix.component }} component"
        
        # Check if component files exist
        if [ -f "Components/${{ matrix.component }}/${{ matrix.component }}.razor" ]; then
          echo "âœ… Component file found"
        else
          echo "âš ï¸ Component file not found (may be in development)"
        fi
        
        # Run component-specific build
        dotnet build --configuration Debug
        
        echo "ğŸ“‹ Component validation completed for ${{ matrix.component }}"

  # Development phase tracking
  phase-validation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check development phase
      run: |
        echo "ğŸ“ˆ Development Phase Validation"
        echo "Current branch: ${{ github.ref_name }}"
        
        # Check which phase features are implemented
        phase_1_1_features=(
          "Components/TaskGrid/TaskGrid.razor:TaskGrid with tree structure"
          "Models/GanttTask.cs:Data models"
          "Services/GanttRowAlignmentService.cs:Row alignment service"
          "Pages/GanttDemo.razor:Demo page"
        )
        
        phase_1_2_features=(
          "Components/TimelineView/TimelineView.razor:TimelineView component"
          "Components/TimelineView/TimelineView.razor.css:Timeline styling"
        )
        
        phase_1_3_features=(
          "Components/GanttComposer/GanttComposer.razor:Integration component"
        )
        
        echo "ğŸ—ï¸ Phase 1.1 Features (TaskGrid):"
        for feature in "${phase_1_1_features[@]}"; do
          file="${feature%%:*}"
          desc="${feature##*:}"
          if [ -f "$file" ]; then
            echo "  âœ… $desc"
          else
            echo "  âŒ $desc"
          fi
        done
        
        echo ""
        echo "ğŸ—ï¸ Phase 1.2 Features (TimelineView):"
        for feature in "${phase_1_2_features[@]}"; do
          file="${feature%%:*}"
          desc="${feature##*:}"
          if [ -f "$file" ]; then
            echo "  âœ… $desc"
          else
            echo "  ğŸ”„ $desc (planned)"
          fi
        done
        
        echo ""
        echo "ğŸ—ï¸ Phase 1.3 Features (Integration):"
        for feature in "${phase_1_3_features[@]}"; do
          file="${feature%%:*}"
          desc="${feature##*:}"
          if [ -f "$file" ]; then
            echo "  âœ… $desc"
          else
            echo "  ğŸ“‹ $desc (planned)"
          fi
        done

  # PR readiness check
  pr-readiness:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: PR Readiness Check
      run: |
        echo "ğŸ” Pull Request Readiness Check"
        echo "PR: ${{ github.event.pull_request.title }}"
        echo "Author: ${{ github.event.pull_request.user.login }}"
        echo "Base: ${{ github.event.pull_request.base.ref }}"
        echo "Head: ${{ github.event.pull_request.head.ref }}"
        
        # Check for required files
        required_files=("README.md" "basic_gantt_plan.md" ".github/copilot-instructions.md")
        
        echo ""
        echo "ğŸ“‹ Required Files Check:"
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "  âœ… $file"
          else
            echo "  âŒ $file (missing)"
          fi
        done
        
        # Check commit message format
        echo ""
        echo "ğŸ’¬ Recent Commits:"
        git log --oneline -5

  # Auto-labeling for PRs
  auto-label:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Auto-label PR
      uses: actions/labeler@v5
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        configuration-path: .github/labeler.yml

  # Development metrics
  dev-metrics:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Development Metrics
      run: |
        echo "ğŸ“Š Development Metrics"
        echo "======================"
        
        # Count lines of code by type
        echo "ğŸ“ Lines of Code:"
        echo "  C# files: $(find . -name "*.cs" -not -path "./bin/*" -not -path "./obj/*" | xargs wc -l | tail -1 | awk '{print $1}')"
        echo "  Razor files: $(find . -name "*.razor" -not -path "./bin/*" -not -path "./obj/*" | xargs wc -l | tail -1 | awk '{print $1}')"
        echo "  CSS files: $(find . -name "*.css" -not -path "./bin/*" -not -path "./obj/*" -not -path "./wwwroot/css/bootstrap/*" -not -path "./wwwroot/css/open-iconic/*" | xargs wc -l | tail -1 | awk '{print $1}')"
        
        echo ""
        echo "ğŸ—ï¸ Component Progress:"
        echo "  TaskGrid: $([ -f "Components/TaskGrid/TaskGrid.razor" ] && echo "âœ… Implemented" || echo "âŒ Pending")"
        echo "  TimelineView: $([ -f "Components/TimelineView/TimelineView.razor" ] && echo "âœ… Implemented" || echo "ğŸ”„ In Progress")"
        echo "  GanttComposer: $([ -f "Components/GanttComposer/GanttComposer.razor" ] && echo "âœ… Implemented" || echo "ğŸ“‹ Planned")"
        
        echo ""
        echo "ğŸ“¦ Dependencies:"
        if [ -f "GanttComponents.csproj" ]; then
          echo "  NuGet packages: $(grep -c 'PackageReference' GanttComponents.csproj || echo "0")"
        fi
